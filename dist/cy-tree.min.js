"use strict";!function(a){var b=a.module("cyTree",[]);b.service("cyTreeUtils",[function(){function b(a,c,d,e,f){var g,h,i=a&&a.length;if(i&&e)for(;i--;){if(h=a[i],g=h[c],e(h,d,g),f&&f(h,d,g))return;b(g,c,h,e)}}function c(a,b,d,e){if(a&&d){var f=a[b];d(f,a),e&&e(f,a)||f&&c(f,b,d)}}var d=0,e="cyTree",f={s2n:function(a,b){var c,d,e=0;if(a.selectedCount--,a.selected)0===a.selectedCount?(c="s2n",a.nonSelected=!0):(c="s2p",a.partSelected=!0),a.selected=!1;else{if(a.selectedCount>0)c="stable";else{for(d=b.length;d--;)b[d].partSelected&&e++;c=e>0?"stable":"p2n"}"p2n"===c&&(a.partSelected=!1,a.nonSelected=!0)}return c},s2p:function(a){var b;return a.selectedCount--,b=a.selected?"s2p":"stable",a.partSelected=!0,a.selected=!1,b},p2n:function(a){var b;return 0===a.selectedCount?(b="p2n",a.partSelected=!1,a.nonSelected=!0):b="stable",b},p2s:function(a,b){var c;return a.selectedCount++,a.selectedCount===b.length?(c="p2s",a.partSelected=!1,a.selected=!0):c="stable",c},n2s:function(a,b){var c;return a.selectedCount++,a.partSelected?a.selectedCount===b.length?(c="p2s",a.selected=!0,a.partSelected=!1):c="stable":(a.nonSelected=!1,b.length>1?(a.partSelected=!0,c="n2p"):(a.selected=!0,c="n2s")),c},n2p:function(a){var b;return a.partSelected?b="stable":(a.partSelected=!0,a.nonSelected=!1,b="n2p"),b}},g=function(a,b,c){return"<ul><li ng-class=\"{'last-node': $last, 'has-child': node."+b+'.length}" ng-repeat="node in '+a+'"><i class="tree-icon css-icon" ng-if="node.'+b+'.length" ng-click="treeMethods.collapseNode(node)" ng-class="{\'icon-triangle-right-small\': node.collapsed, \'icon-triangle-bottom-small\': !node.collapsed}"></i><i class="tree-icon css-icon icon-space" ng-if="!node.'+b+'.length"></i><i class="tree-icon css-icon" ng-class="{\'icon-box\': node.nonSelected, \'icon-success\': node.selected, \'icon-box2\': node.partSelected}" ng-click="treeMethods.selectNode(node)"></i><span class="tree-label">{{node.'+c+'}}</span><div class="cy-sub-tree" ng-if="node.'+b+'.length" ng-hide="node.collapsed" tree-data="node.'+b+'"></div></li></ul>'};this.genTemplate=g,this.genUniqueId=function(){return e+ ++d},this.getTreeCount=function(){return d},this.iterateDown=b,this.iterateUp=c,this.handlingNodeUp=function(a,b,d,e){c(a,d,function(a){a&&(b=f[b](a,a[e]))},function(a){return!a||"stable"===b})},this.formatData=function(c,d,e,f,g){if(!c||!c.length)return[];g=g||a.noop;for(var h,i=c.length,j={};i--;){var k=c[i],l=(k[f],k[e]);g(k),l===d&&(h=k),j[l]||(j[l]=[]),j[l].push(k)}return h.list=j[d],b(h.list,"list",null,function(a){a.list=j[a[f]]}),[h]}}]),b.controller("cyTreeController",function(a,b,c){var d,e,f,g,h,i,j,k,l,m,n=c.genUniqueId(),o=a.treeMethods={},p=a.treeInfo={treeId:n},q=0;this.init=function(q,r,s){function t(a,b,c,d){return a.leafNode?void(void 0!==d?(a.selected=d,a.nonSelected=!d):(a.selected=!!a.selected,a.nonSelected=!a.selected)):(a.selected=!1,a.partSelected=!1,a.nonSelected=!1,void(0===b?a.nonSelected=!0:c>b?a.partSelected=!0:a.selected=!0))}i=q.treeData,j=q.treeChildFlag||"list",k=q.treeLabelFlag||"name",l=q.debugMode,f=r,d=!!s,m=function(){l&&b.debug&&b.debug.apply(this,arguments)},m("cyTree:about to init",n),r?(h=r.replace(/ng-repeat\s*=\s*(['"])\s*node\s+in\s+\w+\s*\1/,"ng-repeat=$1node in "+i+"$1"),g=r.replace(/ng-repeat\s*=\s*(['"])\s*node\s+in\s+\w+\s*\1/,"ng-repeat=$1node in node."+j+"$1")):(h=c.genTemplate(i,j,k),g=c.genTemplate("node."+j,j,k)),d||(e=a.$watch(i,function(b){void 0!==b&&(m("cyTree:about to handle raw data",b),e(),e=null,c.iterateDown(a[i],j,null,function(a,b,c){var d,e=0,f=0;if(a.parent=b,c&&c.length){for(e=d=c.length;d--;)c[d].selected&&f++;a.selectedCount=f}else a.selectedCount=0,a.leafNode=!0;t(a,f,e),a.collapsed=!!a.collapsed}))})),o.collapseNode=function(b){m("cyTree:collapseNode",n),b.collapsed=!b.collapsed,p.currentCollapsedNode=b,a.$emit("treecollapse",b)},o.selectNode=function(b){if(b){m("cyTree:about to select node",b);var d,e,f=b.nonSelected;f?(d=!0,b.selected=!0,b.nonSelected=!1,e="n2s",b.selectedCount=b[j]?b[j].length:0):(d=!1,e=b.selected?"s2n":"p2n",b.nonSelected=!0,b.selected=!1,b.selectedCount=0),b.partSelected=!1,p.currentSelectedNode=b,c.handlingNodeUp(b,e,"parent",j),b.leafNode||c.iterateDown([b],j,null,function(a,c,e){var f=0;b!==a&&(d?e&&(f=a.selectedCount=e.length):a.selectedCount=0,t(a,a.selectedCount,f,d))}),a.$emit("treeselect",b)}}},this.getSubTreeTemplate=function(){return g},this.getSuperTreeTemplate=function(){return h},this.getTreeTemplate=function(){return q++?g:h}}),b.directive("cyTree",["$log","$compile","cyTreeUtils",function(){return{restrict:"A",scope:!0,controller:"cyTreeController",priority:1,compile:function(a){var b=a.html();return a.html(""),{pre:function(a,c,d,e){e.init(d,b)}}}}}]),b.directive("treeData",["$q","$compile","cyTreeUtils",function(a,b){return{restrict:"A",require:"^cyTree",scope:!0,link:function(a,c,d,e){c.append(b(e.getTreeTemplate())(a))}}}])}(angular);